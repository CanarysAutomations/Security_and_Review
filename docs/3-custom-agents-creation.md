# Exercise 3: Create Custom Agents - Generate Fix Guides Using Copilot CLI
## Building Domain-Specific Vulnerability Fixes

**Duration**: 20 minutes  
**Type**: â­â­â­â­ Agent creation  
**Focus**: Use Copilot CLI to CREATE custom agents (.md guides) for fixing vulnerabilities

---

## ðŸŽ¯ Learning Objectives

âœ… Understand what a "custom agent" is (fix documentation)  
âœ… Use Copilot CLI to GENERATE fix guides directly  
âœ… Save agent files directly from Copilot CLI output  
âœ… Create `.md` agent files for SecureTrails vulnerabilities  
âœ… Build a library of custom agents for your domain  

---

## ðŸ“– What is a Custom Agent?

**In this workshop, a "Custom Agent" is:**
- A `.md` file that documents HOW to fix a specific vulnerability
- Created using Copilot CLI prompts
- Contains step-by-step remediation instructions
- Stored in `.github/agents/` as reference guides
- Used by developers to understand AND fix issues

**Simply**: Intelligent documentation for fixing security issues, **generated by Copilot CLI**.

---

## ðŸš€ Step 1: Generate SQL Injection Fix Agent with Copilot CLI

**Run this command in your terminal** to generate the agent directly from Copilot CLI:

```bash
npx @github/copilot -i "I'm a lead dev at SecureTrails (Flask/Python app) flagged by GitHub GHAS for SQL injection in our database layer.

Here's what we found:
- File: app.py, Line 47
- Problem: User input from request.args directly concatenated into SQL queries
- Example: query = f\"SELECT * FROM trails WHERE location = '{user_input}'\"
- This breaks auth AND lets attackers dump the entire database

I need to create a remediation guide for our team (2 seniors, 1 junior).

Create a structured, implementable guide covering:
1. What's the risk? (what could attackers actually DO?)
2. Root cause analysis (where in our code?)
3. Step-by-step fix process
4. Before/After code examples (show Python SQLAlchemy AND raw DB-API patterns)
5. Testing strategy (including injection payloads to try)
6. Common mistakes (hardcoding IDs, forgetting session checks, etc)
7. Timeline (how long should this take?)

Make it something we can hand to a developer without needing hand-holding. Output as valid markdown."
```

**Copilot generates** the complete remediation guide in your terminal.

---

## ðŸ’¾ Step 2: Save Agent Directly Using Terminal

**Copy Copilot's entire output**, then save it directly using ONE of these methods:

### Option A: PowerShell (Windows) - FASTEST

```powershell
# 1. Highlight all Copilot output in terminal
# 2. Copy with Ctrl+C
# 3. Run this command:

mkdir -p .github/agents

@"
[PASTE_COPILOT_OUTPUT_HERE]
"@ | Out-File -Path ".github/agents/sql-injection-fix-guide.md" -Encoding UTF8

# Verify:
cat .github/agents/sql-injection-fix-guide.md
```

### Option B: Bash/Mac/Linux

```bash
mkdir -p .github/agents

cat > .github/agents/sql-injection-fix-guide.md << 'EOF'
[PASTE_COPILOT_OUTPUT_HERE]
EOF
```

### Option C: VS Code (If typing easier)

1. Copilot output â†’ Select all â†’ Copy
2. VS Code: `Ctrl+K Ctrl+O` â†’ New File
3. Paste â†’ Save as `.github/agents/sql-injection-fix-guide.md`

**Then commit:**

```bash
git add .github/agents/sql-injection-fix-guide.md
git commit -m "docs: Add SQL injection remediation guide agent"
git push
```

âœ… **First agent created directly from Copilot CLI!**

---

## ðŸ”„ Step 3: Create Remaining Agents (3 more)

**REPEAT the exact same pattern:**

### Agent 2: Authentication & Authorization Fix

```bash
npx @github/copilot -i "Our SecureTrails Flask app has broken authentication flagged by GitHub GHAS.
Problem: No user permission validation on data modifications.
- User A modifies User B's bookings by changing URL parameter
- Sessions exist but no checks on PUT/DELETE/POST
- Example: DELETE /booking/123 should verify user owns it

Create remediation guide:
1. Business risk
2. Root cause
3. Fix with Flask decorators  
4. Before/After code
5. How to test
6. Common mistakes
7. Timeline

Include Flask-Login. Output as markdown."
```

Save to: `.github/agents/authentication-fix-guide.md`

---

### Agent 3: XSS Prevention Fix

```bash
npx @github/copilot -i "GitHub GHAS flagged XSS in Jinja2 templates - user comments rendered without escaping.

Risk: Attackers inject JavaScript (steal cookies, redirect).

Create guide:
1. How XSS exploits templates
2. Why it's dangerous
3. Jinja2 escaping patterns  
4. Before/After templates
5. Content Security Policy headers
6. Testing - verify payloads neutralized
7. Performance impact?

Output as markdown."
```

Save to: `.github/agents/xss-fix-guide.md`

---

### Agent 4: Dependency Security Fix

```bash
npx @github/copilot -i "Our requirements.txt has vulnerable dependencies (Flask 1.1.2â†’2.3.0, Jinja2 2.11â†’3.1.0).

Need safe upgrade process without breaking app.

Create guide:
1. Upgrade risks
2. Breaking changes Flask 1.xâ†’2.x
3. Testing strategy
4. Rollback plan
5. Upgrade order
6. Regression verification
7. Documentation checklist

2-hour regression window. Output as markdown."
```

Save to: `.github/agents/dependency-update-guide.md`

---

## âœ… Your Custom Agent Library

After this exercise:

```
.github/agents/
â”œâ”€â”€ sql-injection-fix-guide.md
â”œâ”€â”€ authentication-fix-guide.md
â”œâ”€â”€ xss-fix-guide.md
â””â”€â”€ dependency-update-guide.md
```

All generated by Copilot CLI, saved via terminal commands.

---

## ðŸŽ¯ Key Point: Copilot CLI Workflow

**NO manual file creation in VS Code needed:**

1. Copilot CLI generates â†’ Terminal output
2. Copy output
3. Save direclty via PowerShell/bash or paste in VS Code
4. Commit to git
5. Done!

Agents are documentation guides generated by AI, delivered through CLI.

---

## âœ… Acceptance Criteria

- [ ] Created 4 custom agents using Copilot CLI
- [ ] All agents in `.github/agents/` as `.md` files
- [ ] Each has before/after code examples
- [ ] Each has step-by-step fix instructions
- [ ] All committed and pushed to git
- [ ] Understand CLI-first workflow (no VS Code file creation needed)

---

## ðŸš€ Next Exercise

**Exercise 4**: GitHub Actions - Link GHAS findings â†’ Custom agents â†’ Developer workflow

---

**â±ï¸ Time**: 20 min | **Exercises**: 3/5 âœ“

## Building Domain-Specific Vulnerability Fixes

**Duration**: 20 minutes  
**Type**: â­â­â­â­ Agent creation  
**Focus**: Use Copilot CLI to CREATE custom agents (.md guides) for fixing vulnerabilities

---

## ðŸŽ¯ Learning Objectives

âœ… Understand what a "custom agent" is (fix documentation)  
âœ… Use Copilot CLI to GENERATE fix guides  
âœ… Create `.md` agent files for SecureTrails vulnerabilities  
âœ… Document step-by-step remediation processes  
âœ… Build a library of custom agents for your domain  

---

## ðŸ“– What is a Custom Agent?

**In this workshop, a "Custom Agent" is:**
- A `.md` file that documents HOW to fix a specific vulnerability
- Created using Copilot CLI prompts
- Contains step-by-step remediation instructions
- Stored in `.github/agents/` as reference guides
- Used by developers to understand AND fix issues

**NOT**:
- Pre-built Python scripts (we don't use those)
- Automated executables
- Magic frameworks

**Simply**: Intelligent documentation for fixing security issues.

---

## ðŸ“‹ The Vulnerability We Found

From Exercise 1 (GitHub GHAS), we detected:

```
ðŸ”´ CRITICAL: SQL Injection in database query layer
File: apps/securetrails-vulnerable/app.py
Line: ~47
Issue: User input directly concatenated into SQL query
```

Example vulnerable code:
```python
user_input = request.args.get('location')
query = f"SELECT * FROM trails WHERE location = '{user_input}'"
database.execute(query)  # VULNERABLE!
```

**Now**: Use Copilot CLI to CREATE a fix guide (custom agent).

---

## ðŸš€ Step 1: Launch Copilot CLI

Use the npx command with your prompt:

```bash
npx @github/copilot -i "Create a comprehensive remediation guide for fixing SQL Injection"
```

This launches an interactive session where you can ask follow-up questions.

---

## ðŸ› ï¸ Step 2: Create SQL Injection Fix Agent

Ask Copilot CLI to generate a fix guide:

```bash
npx @github/copilot -i "I'm a lead dev at SecureTrails (Flask/Python app) flagged by GitHub GHAS for SQL injection in our database layer.

Here's what we found:
- File: app.py, Line 47
- Problem: User input from request.args directly concatenated into SQL queries
- Example: query = f\"SELECT * FROM trails WHERE location = '{user_input}'\"
- This breaks auth AND lets attackers dump the entire database

I need to create a remediation guide for our team (2 seniors, 1 junior).

Create a structured, implementable guide covering:
1. What's the risk? (what could attackers actually DO?)
2. Root cause analysis (where in our code?)
3. Step-by-step fix process
4. Before/After code examples (show Python SQLAlchemy AND raw MySQLdb patterns)
5. Testing strategy (including injection payloads to try)
6. Gotchas & common mistakes (what could go wrong?)
7. Timeline (how long should this take?)

Make it something we can hand to a developer without needing hand-holding."
```

**Copilot responds** with structured remediation guide:

```markdown
# SQL Injection Fix Guide - SecureTrails Database Layer

## Executive Summary
SQL Injection is a CRITICAL vulnerability allowing attackers to:
- Extract all database records
- Modify or delete data
- Escalate privileges

**Risk Level**: CRITICAL
**Effort**: 2-4 hours
**Impact**: Prevents remote code execution

## Root Cause
User input from `request.args.get('location')` is directly interpolated into SQL queries.
The string formatting operator (`f"..."`) does NOT sanitize input.

## Remediation Steps

### Step 1: Identify All Vulnerable Query Points
```bash
grep -r "f\"SELECT" apps/securetrails-vulnerable/
grep -r "f'SELECT" apps/securetrails-vulnerable/
grep -r "query = f" apps/securetrails-vulnerable/
```

### Step 2: Understand Parameterized Queries
Parameterized queries separate SQL code from data:
```python
# VULNERABLE - String interpolation
query = f"SELECT * FROM users WHERE id = {user_id}"

# SAFE - Parameterized query
query = "SELECT * FROM users WHERE id = ?"
cursor.execute(query, (user_id,))
```

The `?` is a placeholder. User_id is passed separately, so it's treated as DATA, not code.

### Step 3: Fix the Code

**BEFORE (Vulnerable)**:
```python
@app.route('/api/trails')
def search_trails():
    location = request.args.get('location')
    query = f"SELECT * FROM trails WHERE location = '{location}'"
    results = db.execute(query)
    return jsonify(results)
## ðŸ› ï¸ Step 2: Create SQL Injection Fix Agent with Copilot CLI

**In your terminal, run this command** to generate the agent directly:

```bash
npx @github/copilot -i "I'm a lead dev at SecureTrails (Flask/Python app) flagged by GitHub GHAS for SQL injection in our database layer.

Here's what we found:
- File: app.py, Line 47
- Problem: User input from request.args directly concatenated into SQL queries
- Example: query = f\"SELECT * FROM trails WHERE location = '{user_input}'\"
- This breaks auth AND lets attackers dump the entire database

I need to create a remediation guide for our team (2 seniors, 1 junior).

Create a structured, implementable guide covering:
1. What's the risk? (what could attackers actually DO?)
2. Root cause analysis (where in our code?)
3. Step-by-step fix process (like: identify vulnerable points, use parameterized queries, test with payloads)
4. Before/After code examples (show Python SQLAlchemy AND raw DB-API patterns)
5. Testing strategy (including injection payloads to try)
6. Common mistakes (hardcoding IDs, forgetting session checks, etc)
7. Timeline (how long should this take?)

Make it something we can hand to a developer without needing hand-holding. Output as valid markdown."
```

**Copilot generates** the complete remediation guide in your terminal.

---

## ðŸ“ Step 3: Save Agent Directly Using Terminal

**Copy Copilot's entire output** and save it directly to the file:

```bash
# Create the agents directory if it doesn't exist
mkdir -p .github/agents

# Save the Copilot output to the agent file
# (Paste Copilot's output and save as shown below:)
```

**Option A: Use PowerShell (Windows)**

After Copilot generates the guide:
1. Highlight and copy all the generated markdown output
2. Run this to save it:

```powershell
# Paste the content into a file directly
@"
[PASTE_COPILOT_OUTPUT_HERE]
"@ | Out-File -Path ".github/agents/sql-injection-fix-guide.md" -Encoding UTF8
```

**Option B: Use bash/MacOS/Linux**

```bash
# Copy Copilot output, then save directly:
cat > .github/agents/sql-injection-fix-guide.md << 'EOF'
[PASTE_COPILOT_OUTPUT_HERE]
EOF
```

**Option C: Fastest - Use VS Code to paste**

1. Copilot generates output â†’ Select all â†’ Copy
2. VS Code: Press `Ctrl+K Ctrl+O` to create new file
3. Paste the content
4. Save as: `.github/agents/sql-injection-fix-guide.md`
5. Commit in terminal:

```bash
git add .github/agents/sql-injection-fix-guide.md
git commit -m "docs: Add SQL injection remediation guide agent"
git push
```

âœ… **Agent saved directly from Copilot CLI output!**

---

## ðŸ”„ Step 4: Create More Agents - Same Pattern

Follow the same pattern for each vulnerability GHAS found:

### Agent 2: Authentication & Authorization Fix

```bash
npx @github/copilot -i "Our SecureTrails Flask app has broken authentication flagged by GitHub GHAS.
Problem: No user permission validation on data modifications.
- User A can modify User B's bookings by changing URL parameter
- Sessions exist but aren't checked on PUT/DELETE/POST
- Example: DELETE /booking/123 should verify logged-in user OWNS it

Create a remediation guide covering:
1. Business risk (attackers can book/cancel other users' trips)
2. Root cause (session handling vs permission validation)
3. Fix implementation (Flask decorators for authorization checks)
4. Before/After code (vulnerable vs secure endpoint)
5. How to test permission boundaries
6. Common mistakes (hardcoding IDs, missing session checks)
7. Timeline (implementable in 1-2 days?)

Include Flask-Login patterns. Format as .md"
```

**Save to**: `.github/agents/authentication-fix-guide.md`

---

### Agent 3: XSS Prevention Fix

```bash
npx @github/copilot -i "GitHub GHAS flagged XSS in our Jinja2 templates - user comments/descriptions rendered without HTML escaping.

Risk: Attackers inject JavaScript in other users' browsers (steal cookies, redirect to malware).

Create a remediation guide:
1. How XSS exploits our Jinja2 templates (what pattern is wrong?)
2. Why it's dangerous for trail booking (we store user comments)
3. Jinja2 escaping patterns and how autoescape works
4. Before/After template examples
5. Content Security Policy headers for app.py
6. Testing - verify XSS payloads are neutralized
7. Performance impact of escaping?

We're inconsistently escaping. Explain when it's needed vs not. Format as .md"
```

**Save to**: `.github/agents/xss-fix-guide.md`

---

### Agent 4: Dependency Security Fix

```bash
npx @github/copilot -i "Our requirements.txt has vulnerable dependencies flagged by Dependabot (Flask 1.1.2â†’2.3.0, Jinja2 2.11â†’3.1.0, etc).

We need a safe upgrade process without breaking the app.

Create a remediation guide:
1. Risks of upgrading vs NOT upgrading
2. Breaking changes between Flask 1.x and 2.x
3. Testing strategy (unit? integration? manual?)
4. Rollback plan if something breaks
5. Step-by-step upgrade order
6. How to verify no regression
7. Documentation checklist

We have a 2-hour regression test window. Format as .md"
```

**Save to**: `.github/agents/dependency-update-guide.md`

---

## âœ… Your Custom Agent Library

After this exercise, you'll have:

```
.github/agents/
â”œâ”€â”€ sql-injection-fix-guide.md .............. Fix SQL injection
â”œâ”€â”€ authentication-fix-guide.md ............ Fix auth issues
â”œâ”€â”€ xss-fix-guide.md ...................... Fix XSS vulnerabilities
â””â”€â”€ dependency-update-guide.md ............ Safe dependency updates
```

**These are your CUSTOM AGENTS** - Copilot-generated fix guides for YOUR domain.

---

## ðŸŽ¯ Key Insight: Custom Agents = Smart Documentation

**What custom agents do**:
- âœ… Explain WHAT vulnerability exists (why GitHub flagged it)
- âœ… Explain WHY it's dangerous (business impact)
- âœ… Show BEFORE/AFTER code examples
- âœ… Provide step-by-step fix instructions
- âœ… Include testing strategies
- âœ… Prevent developers from making mistakes

**What they DON'T do**:
- âŒ Automatically fix code (that's developer's job)
- âŒ Run as background services
- âŒ Execute code
- âŒ Bypass manual review

**They guide, not automate.**

---

## ðŸ’¡ Using Custom Agents in Workflow

In Exercise 4 (GitHub Actions), we'll:

1. GHAS finds vulnerability â†’ Creates issue
2. Issue links to custom agent (fix guide)
3. Developer reads agent guide
4. Developer applies fixes following guide
5. Re-runs GHAS to verify fix
6. Issue closes when fixed

---

## âœ… Acceptance Criteria

- [ ] Used Copilot CLI to create at least 1 custom agent
- [ ] Saved agent as `.md` file in `.github/agents/`
- [ ] Agent includes: Problem, Why it's bad, Before/After code, Fix steps
- [ ] Agent is formatted for easy developer reading
- [ ] Created minimum 2 agents (one required, one bonus)
- [ ] Understand agents are documentation, not code execution
- [ ] Can explain how agents will be used in GitHub Actions

---

## ðŸ“š Agent Best Practices

When creating custom agents via Copilot CLI:

1. **Be Specific**: Include exact file names and line numbers from GHAS findings
2. **Show Examples**: Include actual before/after code
3. **Step-by-Step**: Number each action clearly
4. **Add Testing**: How to verify the fix works
5. **Link to Standards**: Reference OWASP, CWE where applicable
6. **Include Effort**: Time estimate for developers
7. **Add Validation**: Checklist to verify completion

---

## ðŸš€ Next Steps

**Exercise 4**: GitHub Actions Integration
- Connect GHAS findings â†’ Custom agent guides â†’ Developer workflow
- Automate issue creation with agent links
- Track remediation progress

---

**â±ï¸ Time**: 20 min | **Exercises**: 3/5 âœ“

**You just created your FIRST custom agent using Copilot CLI!**
